blueprint:
  name: "Automatische Updates"
  description: >
    Automation um System- und HACS-Updates automatisch zu erkennen und zu installieren.
    v0.0.7 - Made by Ahmalo
  domain: automation
  input:
    # SEKTION 1: TIMING
    check_time:
      name: Startzeitpunkt
      description: Wann soll t√§glich nach Updates gesucht werden?
      default: "20:00:00"
      selector:
        time: {}

    force_install_time:
      name: Installationszeitpunkt
      description: Updates werden zu dieser Zeit automatisch installiert, wenn nicht vorher reagiert wurde.
      default: "04:00:00"
      selector:
        time: {}

    # SEKTION 2: BENACHRICHTIGUNG
    notify_targets:
      name: Mobile Benachrichtigung
      description: Ger√§te oder Personen, die benachrichtigt werden sollen.
      default: {}
      selector:
        object:
          fields:
            devices:
              name: Ger√§te
              selector:
                device:
                  filter:
                    - integration: mobile_app
                  multiple: true
            persons:
              name: Personen
              selector:
                entity:
                  domain: person
                  multiple: true
            # Hinweis: 'action' (fr√ºher service) unterst√ºtzt kein 'multiple' in diesem Kontext.
            # Wir nutzen hier einen Entity-Selector f√ºr Notify-Gruppen oder einzelne Dienste.
            services:
              name: Benachrichtigungsdienste
              selector:
                entity:
                  domain: notify
                  multiple: true

    enable_persistent_notification:
      name: Interne-Benachrichtigung
      description: Benachrichtigung in Home Assistant (UI) anzeigen
      default: true
      selector:
        boolean: {}

    # SEKTION 3: UPDATE OPTIONEN
    create_backup:
      name: Vorheriges Backup
      description: Soll vor jedem Update ein Backup erstellt werden?
      default: false
      selector:
        boolean: {}

    ha_restart:
      name: Neustart nach Abschluss
      description: Startet Home Assistant nach der Installation aller Updates neu
      default: true
      selector:
        boolean: {}

mode: single

trigger:
  - platform: time
    at: !input check_time

condition:
  - condition: template
    value_template: "{{ expand(states.update) | selectattr('state','eq','on') | list | count > 0 }}"

action:
  - variables:
      updates_entities: "{{ expand(states.update) | selectattr('state','eq','on') | map(attribute='entity_id') | list }}"
      updates_list: "{{ expand(states.update) | selectattr('state','eq','on') | map(attribute='name') | list }}"
      updates_count: "{{ updates_list | count }}"
      updates_text: "{{ updates_list | join(', ') }}"
      targets: !input notify_targets
      devices: "{{ targets.devices if targets.devices is defined else [] }}"
      persons: "{{ targets.persons if targets.persons is defined else [] }}"
      services: "{{ targets.services if targets.services is defined else [] }}"
      use_persistent: !input enable_persistent_notification
      person_device_ids: >-
        {% set r = [] %}
        {% for p in persons %}
          {% for tracker in (state_attr(p, 'device_trackers') | default([])) %}
            {% set dev = device_id(tracker) %}
            {% if dev is not none %}
              {% set r = r + [dev] %}
            {% endif %}
          {% endfor %}
        {% endfor %}
        {{ r | unique | list }}
      all_devices: "{{ (devices + person_device_ids) | unique | list }}"

  # 1. UI Benachrichtigung
  - if:
      - condition: template
        value_template: "{{ use_persistent }}"
    then:
      - action: persistent_notification.create
        data:
          title: "Update-Check: {{ updates_count }} verf√ºgbar"
          message: "Folgende Updates stehen bereit: {{ updates_text }}"
          notification_id: "auto_update_status"

  # 2. Mobile Benachrichtigung (f√ºr Ger√§te)
  - repeat:
      for_each: "{{ all_devices }}"
      sequence:
        - action: "notify.mobile_app_{{ device_entities(repeat.item) | select('search','^notify\\.') | map('regex_replace', 'notify\\.', '') | first }}"
          data:
            title: "üîÑ Updates verf√ºgbar"
            message: "{{ updates_count }} Updates gefunden: {{ updates_text }}"
            data:
              actions:
                - action: INSTALL_UPDATES
                  title: "Sofort installieren"
                - action: ABORT_UPDATES
                  title: "Abbrechen"

  # 2b. Benachrichtigung √ºber notify-Entit√§ten/Dienste
  - repeat:
      for_each: "{{ services }}"
      sequence:
        - action: "{{ repeat.item }}"
          data:
            title: "üîÑ Updates verf√ºgbar"
            message: "{{ updates_count }} Updates gefunden: {{ updates_text }}"

  # 3. Warten auf User-Input oder Zwangs-Zeit
  - wait_for_trigger:
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: INSTALL_UPDATES
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: ABORT_UPDATES
      - platform: time
        at: !input force_install_time
    timeout: "24:00:00"

  # 4. Verarbeitung
  - choose:
      # FALL: User bricht ab
      - conditions:
          - condition: template
            value_template: "{{ wait.trigger is defined and wait.trigger.platform == 'event' and wait.trigger.event.data.action == 'ABORT_UPDATES' }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ use_persistent }}"
            then:
              - action: persistent_notification.create
                data:
                  message: "Installation wurde manuell abgebrochen."
                  notification_id: "auto_update_status"

      # FALL: Installation
      - conditions:
          - condition: or
            conditions:
              - condition: template
                value_template: "{{ wait.trigger is defined and wait.trigger.platform == 'event' and wait.trigger.event.data.action == 'INSTALL_UPDATES' }}"
              - condition: template
                value_template: "{{ wait.trigger is not defined or wait.trigger.platform == 'time' or wait.remaining == 0 }}"
        sequence:
          - if:
              - condition: template
                value_template: "{{ use_persistent }}"
            then:
              - action: persistent_notification.create
                data:
                  message: "Installation von {{ updates_count }} Updates l√§uft..."
                  notification_id: "auto_update_status"

          # INSTALLATION (Runde 1)
          - repeat:
              for_each: "{{ updates_entities }}"
              sequence:
                - action: update.install
                  target:
                    entity_id: "{{ repeat.item }}"
                  data:
                    backup: !input create_backup
                - delay:
                    seconds: 15

          - delay:
              minutes: 1

          # Ergebnis pr√ºfen & Neustart
          - variables:
              failed: "{{ expand(states.update) | selectattr('state','eq','on') | map(attribute='name') | list }}"
          - if:
              - condition: template
                value_template: "{{ failed | count == 0 }}"
            then:
              - if:
                  - condition: template
                    value_template: "{{ use_persistent }}"
                then:
                  - action: persistent_notification.dismiss
                    data:
                      notification_id: "auto_update_status"
              - if:
                  - condition: template
                    value_template: "{{ ha_restart }}"
                then:
                  - action: homeassistant.restart
            else:
              - if:
                  - condition: template
                    value_template: "{{ use_persistent }}"
                then:
                  - action: persistent_notification.create
                    data:
                      title: "‚ùå Updates fehlgeschlagen"
                      message: "Folgende Updates konnten nicht installiert werden: {{ failed | join(', ') }}"
                      notification_id: "auto_update_status"